# GutzNet
Loopholes found in Gutzkowstraße/Reichenbachstraße Studentenwerk network accounting.


## Motivation
Back in October 2015, when I was applying to the BU-TUD abroad program, I knew about the dorm that we students would be living in and about limitations to the Internet access with a 21 GB cap. Being one who tends to consume a lot of data (not even Netflix/video, to be honest), I figured that I would be able to obtain an external internet provider via Vodafone or 1&1 DSL, pay the 15-20€/mo tariff, and get decent (50/10Mbps, which is good even though at home I pull 180/10 and gigabit at BU) internet without traffic limits. 

As it turns out, getting an external provider was a PITA, as Vodafone did not give me any status update for three months after I signed a 2 year contract (voidable due to my short stay), and 1&1 told me that they could not find my TAE-nummer (phone jack to my room), and by May I had basically found a workaround to my data problems as described here and didn't have any motivation to set things up with the telecoms.

## Loopholes
### "Internal" Proxy (v1) 
The traffic accounting rules for Studentenwerk do not apply for so called "internal" traffic. That is to say that traffic within TUD or HTW networks [141.30.0.0/16 (TUD), 141.76.0.0/16 (TUD), and 141.56.0.0/16 (HTW)] do not count, except for if you were connecting to certain servers with static IPs (z.B ZIH VPN or ZIH SSH) where you could technically forward traffic through a tunnel to these servers to the internet. Thus, I needed to grab an IP that was internal but not "blacklisted" from internal accounting. In March, during our pre-semester courses, I found an open Ethernet port in our Kulturkurs room in SE-2. Using a pair of Raspberry Pis running Raspbian and strongSwan (IKEv2 IPsec VPN), I stuck one Pi in the classroom, scripted it to "phone home" to my room's IP (calling the second Pi), and configured routing rules that essentially forwarded traffic to an IP that was accounted as internal and therefore unmetered. With a Pi 2 as remote and Pi 3 as local, I achieved around 70-80Mbps both ways using NULL encryption. A minor caveat was that the classroom ethernet port threw my Pi into a "guest" VLAN (gast.tu-dresden.de), which allowed me to access outgoing ports 80/443/500/4500 only (http/s, vpn, maybe ssh/ftp).

(diagram here)

#### Double Reverse VPN (v1.1)
In late March/early April, I discovered that the particular IP (141.30.3.1) was being metered all of a sudden, and so I scrambled to find more IPs that would work. With two /16 subnets to look for (around 130k IPs), I figured it'd be a whack-a-mole situation, unless entire blocks of internal IP addresses got blocked. I initially used my credentials from BU to log on to eduroam (route traffic through Wifi), but it was not an agile solution as all eduroam clients get a private RFC1918 address that gets NAT'd to a single IP address that appears to be fixed per wireless access point (I'd have to keep moving the Pi to different rooms, and the addresses tended to be blacklisted quickly). I considered using VPN/WEB, which gives a (single?) /22 public block, but a) 1024 addresses for wifi is actually pretty small for a university of this size and b) scripting captive portal autologin was not worth my effort. 

Ironically, I turned to the ZIH VPN service to get internal IPs. While the VPN concentrators were single IP addresses and blacklisted, I learned that they (like BU) hand out public IP addresses to VPN clients, and that the client addresses were not blacklisted. Using my Linode VPS located in London, I used openconnect (Cisco AnyConnect for Linux) and xl2tpd/ppp/openSwan to make connections to the campus VPN and tunnel again through to my room (This inner tunnel used OpenVPN TAP). However, it looks like the AnyConnect VPN performance is rather slow outside TUD; I was pulling around 10-20Mbps symmetric and buying a month of Frankfurt VPS service from DigitalOcean and Leaseweb didn't help (I chose Leaseweb after finding out that DO blocked outgoing 443/udp, which killed performance further. Also, there was that week or so where the ZIH was doing construction work and bandwidth was hurting towards 1-3Mbps before double tunneling overhead, which sucked.) Another minor issue involved the fact that DO, Linode, and Leaseweb IPs are blocked by Netflix (issue raised by my RA), and I had routed traffic from my VPS back through the ZIH VPN (ran into MTU issues) or through BU VPN (+100ms latency).

Eventually all client IPs from the ZIH AnyConnect and L2TP VPNs appeared to be blacklisted (I think it was around 1023[/22] IPs from AnyConnect and 255[/24] for L2TP based on the range of addresses I was getting, so not many anyways). I was thinking about doing the VPN/WEB scripting, but by then I had another idea.

### "Empty Rooms"
Authentication for tenants in the Gutz to access the internet is pretty straightforward. A public IP is assigned to each room statically, and the first device to use that IP binds their MAC-address to that account/room. Of course, one is not bound to use their laptop in their room only; in theory I can go to a suitemate's room, use the internet from my laptop there, and the data is still accounted to me. Therefore, the MAC combined with IP address can be considered a username/password combo, and one should protect both to prevent having his/her data quota used up by someone else. Of note, the network switches appear to be somewhat impervious to a sort of ARP spoofing attack, such that if I tried to used the internet at the same time as someone else, packets get mismatched and both of us are essentially denied reliable service. While one could sniff out the IP/MAC easily (scan for ARP broadcasts) and get uninterrupted service when their target was offline, it's still not a good idea to raise suspicion to an active tenant. However, if a room is empty due to lack of tenants living inside, then there would be no suspicion except if an admin observes traffic coming from a room known to be empty. The trick is to find an IP-MAC combination from an empty room, but the problem is that one cannot passively obtain one through ARP broadcasts if there is no device that is alive.

I stumbled upon the solution to this problem this purely by accident. In the start of April (still using v1.1 plan, probably), I logged on to my account at wh26.tu-dresden.de to check my information from outside the dorm's subnets. Like everyone else, I was given a generated password on the day I moved in in February in a LaTeX-typed document that also contained my static IP info. I had put in that password, but clicked on a different room, and was obviously not getting the result I was expecting. Realizing this, I tried logging into rooms with arbitrary passwords (even using the letter 'a' many times). I was able to get access to the traffic stats for most other rooms in Gutz/Reichenbach, as well as their IP. Moreover, using the Daten link, I could login to these rooms and see the read-only MAC address entry for each account. In one 3-hour thermodynamics course, I curated a table of 50-60 IPs and MACs that did not show any outgoing data in the past 7 days and whose tenants probably left within the past couple of months. (Also, all IP to room pairs are listed in the HTML source of the login page, meaning that anyone on the internet technically can identify a person and their room by their IP.)

Of the 50-60 addresses (circa April 20th), I created a rotation of about 20 IPs, plus myself, my suitemate who uses my wifi, and my RA. I wrote a Python script that would rotate the Linux-based router between the IPs every fixed number of hours, and eventually after a threshold of data consumed. Since I didn't want the old tenants to be spammed with 70/90% data warnings, I changed the email addresses to a dummy account and saved them in a table to be restored later.


## Distribution
For my suitemates, sharing the bandwidth was easy as I had a strong wireless AP (TP-Link Archer C7 v2) with 9dBi omnidirectional antennas. Back in March, I began routing traffic for my RA through my router from her room a floor below. After looking at ARP broadcasts, I concluded that the three subnets for the buildings were in the same VLAN and pointing to the same router; i.e. a Gutz Mitte user can use a Reichenbach IP. Since all of us are mostly in Mitte/212, it wouldn't have been a big deal anyways. I created a RFC1918 subnet 192.168.82.0/24 on an interface connected to the wall by VLAN (no DHCP, to avoid suspicion), with the last number being the same unique identifier. In all, four of my peers located far from my hotspot's range used this method.

I had intended to implement authentication to my RFC1918 subnet via a) AnyConnect VPN tunneling or b) captive portal login, both backed with a RADIUS server that pulled credentials from BU's Kerberos server and my own Active Directory infrastucture, but found it too complicated for end users who used routers or shared their internet from their laptop to their phones.

## Load Balancing fun
In late June, I decided "hey, 100Mbps isn't enough, after all I get 200/200 wifi and gigabit at BU and 180/10 at home!". I also wanted to test the capacity of the high frequency radio link that links the Gutz to the Studentenwerk routers bound for TUD/ZIH. As I have a medium sized room, I had access to two 100Mbps duplex physical links. With a 10m long Ethernet cable, I added an additional link to the jack in my suitemate's room next door. All three lines to the wall connected to my Archer C7, which also functions as a flexible switch with VLAN functionality. Each line had a separate untagged VLAN and the switch trunked these VLANs to my router, an ODROID-C2 that has a gigabit Ethernet port. Using some iptables mangle/fwmark/policy routing magic (mostly copied the rules from mwan3 in OpenWrt), I was able to get a speedtest of ~270Mbps both ways. It's not perfect as session-based websites (z.B. BU studentlink/blackboard) can get confused by multiple IPs, but it's nice for large downloads with multiple connections available. Since 270Mbps is about the theoretical limit of 3 100Mbps links, I can't say that I've hit a limit to the radio link.
